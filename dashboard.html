<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Analytics - Th√®me clair</title>
  <link href="assets/bootstrap.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

    :root {
      --blue: #004779;
      --green: #05683a;
      --yellow: #ffca2e;
      --text-dark: #1a1a1a;
      --text-muted: #555;
      --bg-light: #f8fafc;
      --card-bg: #ffffff;
      --border-light: #e6e6e6;
    }

    body {
      background-color: var(--bg-light);
      color: var(--text-dark);
      font-family: "Poppins", system-ui, sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      padding-bottom: 80px;
    }

    .navbar {
      background: linear-gradient(90deg, var(--blue), var(--green));
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .navbar-brand {
      color: white !important;
      font-weight: 600;
      letter-spacing: 0.6px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-light);
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      transition: all 0.25s ease;
      overflow: visible;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(0,0,0,0.08);
    }

    .card-title {
      font-weight: 600;
      color: var(--blue);
    }

    .kpi-card {
      text-align: center;
      border-top: 4px solid var(--yellow);
      background: var(--card-bg);
    }

    .kpi-card .h3,
    .kpi-card .h5 {
      color: var(--text-dark);
      font-weight: 600;
    }

    .text-muted-small {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    table {
      font-size: 0.95rem;
    }

    table thead th {
      color: var(--blue);
      border-color: var(--border-light);
      font-weight: 600;
    }

    table tbody tr:hover {
      background-color: rgba(0,71,121,0.05);
    }

    footer {
      font-size: 0.85rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border-light);
      background: white;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.8rem 0;
      text-align: center;
    }

    .chart-wrapper {
      position: relative;
      overflow: visible;
      padding-bottom: 30px;
      height: 260px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      border-radius: 10px;
      background: #fdfdfd;
      border: 1px solid #eee;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
    }

    @media (max-width: 767px) {
      canvas {
        height: 300px !important;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">‚ö° Dashboard Analytics</span>
    </div>
  </nav>

  <div class="container my-4">

    <div class="row g-2 my-3">
      <div class="col-md-6">
        <div class="card kpi-card h-100">
          <div class="card-body">
            <div class="text-muted text-uppercase text-muted-small">√âv√©nements total</div>
            <div id="kpiTotal" class="h3 mb-0 fw-bold">‚Äì</div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card kpi-card h-100">
          <div class="card-body">
            <div class="text-muted text-uppercase text-muted-small">Top √©v√©nement</div>
            <div id="kpiTop" class="h5 mb-0 fw-semibold">‚Äì</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">üìä R√©partition par √©v√©nement</h5>
            <div class="chart-wrapper">
              <canvas id="barChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">‚òéÔ∏è Clics par contact</h5>
            <div class="chart-wrapper">
              <canvas id="contactChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-1 mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">üïí √âv√©nements r√©cents</h5>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>date</th>
                    <th>heure</th>
                    <th>√âv√©nement</th>
                    <th>Pays</th>
                  </tr>
                </thead>
                <tbody id="tableRecent"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-1 mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">üìÖ Tendances hebdomadaires (15 derniers jours)</h5>
            <div class="chart-wrapper">
              <canvas id="weeklyChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-1 mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">üóìÔ∏è Tendances mensuelles (dernier mois)</h5>
            <div class="chart-wrapper">
              <canvas id="monthlyChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">

      <div class="col-lg-5">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title">üßÆ Tableau des √©v√©nements</h5>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>√âv√©nement</th>
                    <th class="text-end">Compteur</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">üí¨ D√©tails par contact</h5>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Valeur</th>
                    <th class="text-end">Compteur</th>
                  </tr>
                </thead>
                <tbody id="tableContactValue"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer></footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const $ = id => document.getElementById(id);
    const WORKER_BASE = 'https://cv-analytics.wyxvgyqftb.workers.dev';
    function getWorkerBase(){ return WORKER_BASE; }

    async function fetchStats(endpoint){ 
      const res = await fetch(getWorkerBase() + endpoint, {cache:'no-store'}); 
      if(!res.ok) throw new Error('Fetch failed'); 
      return await res.json(); 
    }

    function translateName(key){
      const map={'page_view':'Vue de page','share_contact':'Partage de la carte','add_to_contacts':'Ajout aux contacts','contact_click':'Clic sur contact','copy_contact':'Copie du lien','test_event':'√âv√©nement test'};
      return map[key]||key;
    }

    function translateContactType(t){
      const map={ phone:'T√©l√©phone', email:'Email', address:'Adresse', website:'Site / R√©seau', social:'R√©seaux sociaux' };
      return map[t]||t||'‚Äî';
    }

    function renderTable(rows){
      const tbody = $('tableBody'); if(!tbody) return;
      tbody.innerHTML=''; rows.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${translateName(r.name)}</td><td class="text-end">${r.count}</td>`; tbody.appendChild(tr); });
    }

    function simplifyContactValue(type, value){
        if(!value) return '‚Äî';
        if(type === 'website'){
          if(value.includes('linkedin')) return 'LinkedIn';
          if(value.includes('facebook')) return 'Facebook';
          if(value.includes('instagram')) return 'Instagram';
          return 'Site Web';
        }
        return value;
      }
      
      function renderContactValueTable(rows){
        const tbody = $('tableContactValue'); if(!tbody) return;
        tbody.innerHTML='';
        rows.forEach(r=>{
          const tr=document.createElement('tr');
          const displayValue = simplifyContactValue(r.type,r.value);
          tr.innerHTML=`<td>${translateContactType(r.type)}</td><td>${displayValue}</td><td class="text-end">${r.count}</td>`;
          tbody.appendChild(tr);
        });
      }


    function renderKpis(rows){
      const total = rows.reduce((s,r)=>s+(r.count||0),0);
      const types = rows.length;
      const top = rows[0]?`${translateName(rows[0].name)} (${rows[0].count})`:'‚Äì';
      const elTotal = $('kpiTotal');
      const elTypes = $('kpiTypes');
      const elTop = $('kpiTop');
      if (elTotal) elTotal.textContent = total;
      if (elTypes) elTypes.textContent = types; // optionnel si pr√©sent
      if (elTop) elTop.textContent = top;
    }

    function renderBarChart(rows){
      const ctx = $('barChart').getContext('2d');
      const labels = rows.map(r=>translateName(r.name));
      const values = rows.map(r=>Number(r.count||0));
      new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'√âv√©nements',
            data:values,
            backgroundColor:['#004779','#05683a','#ffca2e','#ff6f61','#6f42c1','#0dcaf0']
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{
            y:{
              beginAtZero:true,
              ticks:{
                precision:0,
                stepSize:1,
                callback:(val)=> Number.isInteger(val)? val : ''
              }
            }
          }
        }
      });
    }

    function renderContactChart(rows){
      const ctx = $('contactChart').getContext('2d');
      const labels = rows.map(r=>translateContactType(r.type));
      const values = rows.map(r=>Number(r.count||0));
      new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'Clics',
            data:values,
            backgroundColor:['#004779','#05683a','#ffca2e','#ff6f61']
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{
            y:{
              beginAtZero:true,
              ticks:{
                precision:0,
                stepSize:1,
                callback:(val)=> Number.isInteger(val)? val : ''
              }
            }
          }
        }
      });
    }

    function renderShareTable(rows){
      const tbody = $('tableShare');
      if (!tbody) return;
      tbody.innerHTML = '';
      const label = (m)=> m==='native_share' ? 'Partage natif' : (m==='copy_link' ? 'Copie du lien' : (m||'‚Äî'));
      (rows||[]).forEach(r => {
        const tr = document.createElement('tr');
        const tdA = document.createElement('td');
        const tdB = document.createElement('td');
        tdB.className = 'text-end';
        tdA.textContent = label(r.method);
        tdB.textContent = r.count;
        tr.appendChild(tdA); tr.appendChild(tdB);
        tbody.appendChild(tr);
      });
    }

    function startOfISOWeek(d){ const dt=new Date(d); const day=(dt.getDay()+6)%7; dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day); return dt; }
    function yearWeekKey(d){ const s=startOfISOWeek(d); return `${s.getFullYear()}-W${String(Math.ceil((((s - new Date(s.getFullYear(),0,1)) / 86400000) + ((new Date(s.getFullYear(),0,1).getDay()+6)%7)+1)/7)).padStart(2,'0')}`; }
    function yearMonthKey(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

    function buildTimeSeriesByType(events){
      const byWeek = new Map();
      const byMonth = new Map();
      const valid = ['contact_click'];
      events.forEach(ev=>{
        if(!valid.includes(ev.name)) return;
        const d = ev.ts ? new Date(ev.ts) : null; if(!d) return;
        let type = null;
        try { const p = typeof ev.props==='string' ? JSON.parse(ev.props) : ev.props; type = p?.type || null; } catch(_){}
        if(!type) return;
        const wk = yearWeekKey(d);
        const mk = yearMonthKey(d);
        if(!byWeek.has(wk)) byWeek.set(wk,{});
        if(!byMonth.has(mk)) byMonth.set(mk,{});
        byWeek.get(wk)[type] = (byWeek.get(wk)[type]||0)+1;
        byMonth.get(mk)[type] = (byMonth.get(mk)[type]||0)+1;
      });
      return { byWeek, byMonth };
    }

    function renderStackedChart(canvasId, labels, datasets){
      const ctx = $(canvasId).getContext('2d');
      new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets },
        options:{
          responsive:true,
          plugins:{ legend:{ position:'bottom' } },
          scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, ticks:{ precision:0, stepSize:1, callback:(v)=>Number.isInteger(v)?v:'' } } }
        }
      });
    }

    function datasetFor(keys, data, type, color){
      return { label: translateContactType(type), data: keys.map(k=> (data.get(k)?.[type]||0)), backgroundColor: color };
    }

    function renderDonut(canvasId, labels, data, colors){
      const ctx = $(canvasId).getContext('2d');
      new Chart(ctx,{
        type:'doughnut',
        data:{ labels, datasets:[{ data, backgroundColor: colors }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    function sumTypesInRange(events, days){
      const cutoff = Date.now() - days*24*60*60*1000;
      const totals = { phone:0, email:0, address:0, website:0 };
      events.forEach(ev=>{
        if(ev.name!=='contact_click') return;
        const ts = ev.ts ? Date.parse(ev.ts) : NaN; if(!ts || ts<cutoff) return;
        let type=null; try{ const p = typeof ev.props==='string'? JSON.parse(ev.props):ev.props; type=p?.type||null; }catch(_){}
        if(totals[type]!==undefined) totals[type] += 1;
      });
      return totals;
    }

    async function renderTrends(){
      try{
        const recent = await fetchStats('/events/recent?limit=500');
        const list = Array.isArray(recent)? recent : (recent.results||[]);
        const last15 = sumTypesInRange(list, 15);
        const last30 = sumTypesInRange(list, 30);
        const labels = ['T√©l√©phone','Email','Adresse','Site / R√©seau'];
        const colors = ['#004779','#05683a','#ff6f61','#ffca2e'];
        renderDonut('weeklyChart', labels, [last15.phone,last15.email,last15.address,last15.website], colors);
        renderDonut('monthlyChart', labels, [last30.phone,last30.email,last30.address,last30.website], colors);
      }catch(e){ console.error('trends error', e); }
    }

    async function load(){
      try{
        const stats = await fetchStats('/stats');
        const normalized = stats.map(r=>({name:r.name,count:Number(r.count||0)})).sort((a,b)=>b.count-a.count);
        renderTable(normalized);
        renderKpis(normalized);
        renderBarChart(normalized);

        const byContact = await fetchStats('/stats/by-contact');
        renderContactChart(byContact.map(r=>({type:r.type,count:Number(r.count||0)})));

        const byValue = await fetchStats('/stats/by-contact-value');
        renderContactValueTable(byValue.map(r=>({type:r.type,value:r.value,count:Number(r.count||0)})));

        const byShare = await fetchStats('/stats/by-share');
        renderShareTable(byShare.map(r=>({method:r.method,count:Number(r.count||0)})));

        try {
          const recent = await fetchStats('/events/recent?limit=50');
          console.log('recent events raw:', recent);
          const list = Array.isArray(recent) ? recent : (recent.results||[]);
          const tbody = $('tableRecent');
          if (tbody) {
            tbody.innerHTML = '';
            if (!list.length) {
              const tr = document.createElement('tr');
              const td = document.createElement('td');
              td.colSpan = 4;
              td.textContent = 'Aucun √©v√©nement';
              td.className = 'text-center text-muted';
              tr.appendChild(td);
              tbody.appendChild(tr);
            } else {
              list.forEach(ev => {
                const tr = document.createElement('tr');
                const tdDate = document.createElement('td');
                const tdTime = document.createElement('td');
                const tdEvt  = document.createElement('td');
                const tdCountry = document.createElement('td');
                const d = ev.ts ? new Date(ev.ts) : null;
                tdDate.textContent = d ? d.toLocaleDateString('fr-FR') : '‚Äî';
                tdTime.textContent = d ? d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '‚Äî';
                tdEvt.textContent = translateName(ev.name || '‚Äî');
                tdCountry.textContent = ev.country || '‚Äî';
                tr.appendChild(tdDate); tr.appendChild(tdTime); tr.appendChild(tdEvt); tr.appendChild(tdCountry);
                tbody.appendChild(tr);
              });
            }
          }
        } catch(err) { 
          console.error('recent events error:', err);
          const tb=$('tableRecent'); if (tb) tb.innerHTML=''; 
        }

        await renderTrends();
      }catch(e){ console.error(e); }
    }

    document.addEventListener('DOMContentLoaded',load);
  </script>
</body>
</html>




